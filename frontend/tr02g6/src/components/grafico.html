<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visualización de Resultados</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        .node {
            cursor: pointer;
        }

        .circle {
            fill: lightblue;
            stroke: #1f77b4;
            stroke-width: 2px;
        }

        .label {
            font-size: 14px;
            text-anchor: middle;
            fill: black;
        }

        .subcircle {
            fill: lightcoral;
            stroke: #ff6347;
            stroke-width: 2px;
        }

        /* Estilos para los SVG en cuadrícula */
        .svg-container {
            display: grid;
            grid-template-columns: repeat(3, 1fr); /* 3 columnas */
            gap: 20px;
        }
    </style>
</head>
<body>
    <div class="svg-container" id="charts-container"></div>

    <script>
        // Cargar los datos desde el servidor
        fetch('http://localhost:19999/resultats/1') // Reemplaza '1' con el id_clase deseado
            .then(response => response.json())
            .then(data => createCharts(data));

        function createCharts(data) {
            const container = d3.select("#charts-container");

            const width = 2000 / 3; // Ajustar el ancho de cada gráfico
            const height = 1300 / 2; // Ajustar el alto de cada gráfico

            const radius = 80; // Radio de los círculos principales
            const subRadius = 20; // Radio de los subcírculos

            // Crear un gráfico para cada alumno
            data.forEach((alumno, index) => {
                const svg = container.append("div")
                    .append("svg")
                    .attr("width", width)
                    .attr("height", height)
                    .attr("id", `visualization-${index}`);

                const centerX = width / 2;
                const centerY = height / 2;

                // Grupo principal
                const group = svg.append("g")
                    .attr("transform", `translate(${centerX}, ${centerY})`);

                // Nodo central (Nombre del alumno)
                group.append("circle")
                    .attr("class", "circle")
                    .attr("r", radius)
                    .style("fill", "#FFD700");

                group.append("text")
                    .attr("class", "label")
                    .attr("y", 5)
                    .text(alumno.name);

                // Mostrar valor debajo del nombre
                group.append("text")
                    .attr("class", "label")
                    .attr("y", 25) // Desplazar un poco hacia abajo

                // Datos principales
                const mainFields = [
                    { name: "Agressivitat", children: alumno.children[0].children },
                    { name: "Prosocialitat", value: alumno.children[1].value },
                    { name: "Victimització", children: alumno.children[2].children },
                ];

                // Distribuir nodos principales alrededor del centro
                const positions = [
                    { x: 0, y: -1 }, // Arriba
                    { x: 1, y: 0 },  // Derecha
                    { x: -1, y: 0 }, // Izquierda
                    { x: 0, y: 1 },  // Abajo
                ];

                mainFields.forEach((field, i) => {
                    const pos = positions[i];
                    const x = centerX + pos.x * (radius + 100);
                    const y = centerY + pos.y * (radius + 100);

                    const mainGroup = svg.append("g")
                        .attr("transform", `translate(${x}, ${y})`);

                    // Circulo principal
                    mainGroup.append("circle")
                        .attr("class", "circle")
                        .attr("r", field.name === "Prosocialitat" ? radius * (field.value / 10) : radius) // Cambiar tamaño según valor
                        .style("fill", field.name === "Prosocialitat" ? "#90EE90" : "#ADD8E6");

                    // Texto del círculo principal
                    mainGroup.append("text")
                        .attr("class", "label")
                        .attr("y", 5)
                        .text(field.name);

                    // Mostrar valor debajo del nombre
                    mainGroup.append("text")
                        .attr("class", "label")
                        .attr("y", 25)

                    // Si tiene subcampos, añadirlos dentro
                    if (field.children) {
                        const subAngleStep = (2 * Math.PI) / field.children.length;
                        field.children.forEach((subField, j) => {
                            const subAngle = j * subAngleStep;
                            const subX = x + Math.cos(subAngle) * (radius - 20);
                            const subY = y + Math.sin(subAngle) * (radius - 20);

                            svg.append("circle")
                                .attr("class", "subcircle")
                                .attr("r", subRadius * (subField.value / 10)) // Tamaño proporcional
                                .attr("cx", subX)
                                .attr("cy", subY);

                            svg.append("text")
                                .attr("class", "label")
                                .attr("x", subX)
                                .attr("y", subY + 5)
                                .text(subField.name);

                            // Mostrar valor debajo del nombre del subcampo
                            svg.append("text")
                                .attr("class", "label")
                                .attr("x", subX)
                                .attr("y", subY + 25) // Desplazar un poco hacia abajo
                                .text(`${subField.value}`); // Mostrar el valor
                        });
                    }
                });

                // Mostrar los nodos para Popular, Rebutjat, Ignorat, Controvertit y Normatiu solo si tienen un valor no vacío
                const conditionalFields = [
                    alumno.children[3],
                    alumno.children[4],
                    alumno.children[5],
                    alumno.children[6],
                    alumno.children[7],
                ].filter(field => field.value && field.value.trim() !== ""); // Filtrar campos no vacíos
                const conditionalPositions = [
                    { x: 0, y: 1 }, // Abajo del nodo central
                ];

                conditionalFields.forEach((field, i) => {
                  const pos = conditionalPositions[0];
                  const x = centerX + pos.x * (radius + 100) + (i * 100); // Separar horizontalmente
                    const y = centerY + pos.y * (radius + 100);

                    const conditionGroup = svg.append("g")
                        .attr("transform", `translate(${x}, ${y})`);

                    conditionGroup.append("circle")
                        .attr("class", "circle")
                        .attr("r", radius)
                        .style("fill", "#FFA07A");

                    conditionGroup.append("text")
                        .attr("class", "label")
                        .attr("y", 5)
                        .text(field.name);

                    // Mostrar valor debajo del nombre
                    conditionGroup.append("text")
                        .attr("class", "label")
                        .attr("y", 25) // Desplazar un poco hacia abajo
                        .text(`${field.value}`); // Mostrar el valor
                });
            });
        }
    </script>
</body>
</html>
